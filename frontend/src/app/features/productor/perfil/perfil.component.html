<div class="perfil-container">
  <div class="perfil-header">
    <button class="btn-back" (click)="goBack()">
      <i class="fas fa-arrow-left"></i>
      Volver al Dashboard
    </button>
    <h1>Mi Perfil de Productor</h1>
  </div>

  <div class="perfil-content" *ngIf="!loading; else loadingTemplate">
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="perfil-form">
      
      <!-- Imagen del Productor -->
      <div class="form-section">
        <h2>Imagen de la Empresa</h2>
        <div class="image-upload-container">
          <div class="image-preview">
            <img 
              [src]="imagePreview || '/images/default-producer.png'" 
              alt="Vista previa"
              class="preview-image">
            <div class="upload-overlay" *ngIf="uploading">
              <div class="spinner"></div>
              <p>Subiendo imagen...</p>
            </div>
          </div>
          
          <div class="upload-controls">
            <input 
              type="file" 
              id="imageInput" 
              accept="image/*"
              (change)="onFileSelected($event)"
              class="file-input">
            <label for="imageInput" class="btn btn--outline">
              <i class="fas fa-camera"></i>
              Cambiar Imagen
            </label>
            <p class="upload-hint">
              Formatos permitidos: JPG, PNG, WebP. Máximo 5MB.
            </p>
          </div>
        </div>
      </div>

      <!-- Información Básica -->
      <div class="form-section">
        <h2>Información de la Empresa</h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="nombre">Nombre de la Empresa *</label>
            <input 
              type="text" 
              id="nombre"
              formControlName="nombre"
              class="form-control"
              placeholder="Ej: Huerta Los Olivos">
            <div class="field-error" *ngIf="form.get('nombre')?.touched && form.get('nombre')?.errors">
              <span *ngIf="form.get('nombre')?.errors?.['required']">El nombre es obligatorio</span>
              <span *ngIf="form.get('nombre')?.errors?.['minlength']">El nombre debe tener al menos 2 caracteres</span>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="direccion">Dirección *</label>
            <textarea 
              id="direccion"
              formControlName="direccion"
              class="form-control"
              rows="3"
              placeholder="Dirección completa de la empresa o finca"></textarea>
            <div class="field-error" *ngIf="form.get('direccion')?.touched && form.get('direccion')?.errors">
              <span *ngIf="form.get('direccion')?.errors?.['required']">La dirección es obligatoria</span>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="telefono">Teléfono de Contacto *</label>
            <input 
              type="tel" 
              id="telefono"
              formControlName="telefono"
              class="form-control"
              placeholder="123456789">
            <div class="field-error" *ngIf="form.get('telefono')?.touched && form.get('telefono')?.errors">
              <span *ngIf="form.get('telefono')?.errors?.['required']">El teléfono es obligatorio</span>
              <span *ngIf="form.get('telefono')?.errors?.['pattern']">Introduce un teléfono válido (9 dígitos)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Información de la Cuenta -->
      <div class="form-section" *ngIf="productor">
        <h2>Información de la Cuenta</h2>
        
        <div class="info-grid">
          <div class="info-item">
            <label>Email de la cuenta</label>
            <p>{{ currentUser?.email }}</p>
          </div>
          
          <div class="info-item">
            <label>Fecha de registro</label>
            <p>{{ productor.fechaRegistro | date:'dd/MM/yyyy' }}</p>
          </div>
          
          <div class="info-item">
            <label>Tipo de usuario</label>
            <span class="badge badge--green">{{ currentUser?.tipoUsuario }}</span>
          </div>
          
          <div class="info-item">
            <label>ID del productor</label>
            <p>#{{ productor.idProductor }}</p>
          </div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="form-actions">
        <button 
          type="button" 
          class="btn btn--outline"
          (click)="goBack()">
          Cancelar
        </button>
        
        <button 
          type="submit" 
          class="btn btn--primary"
          [disabled]="form.invalid || saving || uploading">
          <i class="fas fa-save" *ngIf="!saving"></i>
          <div class="button-spinner" *ngIf="saving"></div>
          {{ saving ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando perfil...</p>
    </div>
  </ng-template>
</div>